<app-assign-cirlce-members-modal #modal [groupId]="group()?.id" (fetchData)="fetchData()" />
<main class="circle-details-page">
  <section class="breadcrumb-wrap">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
          <a routerLink="/" class="text-decoration-none">Dashboard</a>
        </li>
        <li class="breadcrumb-item">
          <a routerLink="/circles" class="text-decoration-none">Circles</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          {{ group()?.name || "Details" }}
        </li>
      </ol>
    </nav>
  </section>

  @if (isLoading()) {
    <section class="loading-shell">
      <div class="placeholder-glow">
        <span class="placeholder col-6 mb-2"></span>
        <span class="placeholder col-10 mb-2"></span>
        <span class="placeholder col-8"></span>
      </div>
    </section>
  } @else {
    <section class="content-grid">
      <aside class="summary-card">
        <p class="label">Circle</p>
        <h2>{{ group()?.name }}</h2>
        <div class="leader-panel">
          <div class="leader-avatar" [attr.aria-label]="leaderName()">
            @if (leaderAvatarUrl() && !leaderAvatarFailed()) {
              <img
                [src]="leaderAvatarUrl()"
                [alt]="leaderName()"
                (error)="onLeaderAvatarError()"
              />
            } @else {
              <span>{{ leaderInitials() }}</span>
            }
          </div>
          <div class="leader-meta">
            <small>Circle Leader</small>
            <strong>{{ leaderName() }}</strong>
          </div>
        </div>
        <div class="stat-row">
          <span>Members</span>
          <strong>{{ group()?.groupMembers?.length || 0 }}</strong>
        </div>
      </aside>

      <article class="members-card">
        <div class="members-head">
          <h3>Circle Members</h3>
          @if (canRemoveMembers()) {
          <button class="btn btn-primary btn-sm" (click)="open()">
            <i class="bi bi-person-plus me-1"></i>
            Add Member
          </button>
          }
        </div>

        <div class="table-responsive">
          <table class="table align-middle members-table mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Full Name</th>
                <th>Status</th>
                @if (canRemoveMembers()) {
                <th class="text-center">Action</th>
                }
              </tr>
            </thead>
            <tbody>
              @if (errorMessage()) {
              <tr>
                <td
                  class="empty-row text-danger"
                  [attr.colspan]="canRemoveMembers() ? 4 : 3"
                >
                  {{ errorMessage() }}
                </td>
              </tr>
              } @else {
                @for (member of group()?.groupMembers; track member.id) {
                <tr>
                  <td>{{ member.id }}</td>
                  <td>
                    <span>{{ member.firstName }} {{ member.lastName }}</span>
                    @if (member.id === group()?.leaderId) {
                    <span class="leader-pill ms-2">Leader</span>
                    }
                  </td>
                  <td><span class="badge bg-success-subtle text-success-emphasis">Active</span></td>
                  @if (canRemoveMembers()) {
                  <td class="text-center">
                    @if (canRemoveSpecificMember(member.id)) {
                    <button
                      class="btn btn-sm btn-outline-danger"
                      ngbTooltip="Remove from Group"
                      (click)="onRemoveMember(member.id)"
                    >
                      <i class="bi bi-person-x"></i>
                    </button>
                    } @else {
                    <span class="text-muted">-</span>
                    }
                  </td>
                  }
                </tr>
                } @empty {
                <tr>
                  <td [attr.colspan]="canRemoveMembers() ? 4 : 3" class="empty-row">
                    No members found.
                  </td>
                </tr>
                }
              }
            </tbody>
          </table>
        </div>
      </article>
    </section>

    <section class="chat-section">
      <app-circle-chat-panel [groupId]="group()?.id || null" [canAccess]="hasChatAccess()" />
    </section>
  }
</main>
