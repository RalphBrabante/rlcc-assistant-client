<app-assign-cirlce-members-modal #modal [groupId]="group()?.id" (fetchData)="fetchData()" />
<main class="circle-details-page">
  <section class="breadcrumb-wrap">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
          <a routerLink="/" class="text-decoration-none">Dashboard</a>
        </li>
        <li class="breadcrumb-item">
          <a routerLink="/circles" class="text-decoration-none">Groups</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          {{ group()?.name || "Details" }}
        </li>
      </ol>
    </nav>
  </section>

  @if (isLoading()) {
    <section class="loading-shell">
      <div class="placeholder-glow">
        <span class="placeholder col-6 mb-2"></span>
        <span class="placeholder col-10 mb-2"></span>
        <span class="placeholder col-8"></span>
      </div>
    </section>
  } @else {
    <section class="content-grid">
      <aside class="summary-card">
        <p class="label">Group</p>
        <h2>{{ group()?.name }}</h2>
        <div class="leader-panel">
          <div class="leader-avatar" [attr.aria-label]="leaderName()">
            @if (leaderAvatarUrl() && !leaderAvatarFailed()) {
              <img
                [src]="leaderAvatarUrl()"
                [alt]="leaderName()"
                (error)="onLeaderAvatarError()"
              />
            } @else {
              <span>{{ leaderInitials() }}</span>
            }
          </div>
          <div class="leader-meta">
            <small>Group Leader</small>
            <strong>{{ leaderName() }}</strong>
          </div>
        </div>
        <div class="stat-row">
          <span>Members</span>
          <strong>{{ group()?.groupMembers?.length || 0 }}</strong>
        </div>
      </aside>

      <article class="members-card">
        <div class="members-head">
          <h3>Group Members</h3>
          @if (canRemoveMembers()) {
          <button class="btn btn-primary btn-sm" (click)="open()">
            <i class="bi bi-person-plus me-1"></i>
            Add Member
          </button>
          }
        </div>

        <div class="table-responsive">
          <table class="table align-middle members-table mb-0">
            <thead>
              <tr>
                <th>PCO ID</th>
                <th>Full Name</th>
                <th>Status</th>
                @if (canRemoveMembers()) {
                <th class="text-center">Action</th>
                }
              </tr>
            </thead>
            <tbody>
              @if (errorMessage()) {
              <tr>
                <td
                  class="empty-row text-danger"
                  [attr.colspan]="canRemoveMembers() ? 4 : 3"
                >
                  {{ errorMessage() }}
                </td>
              </tr>
              } @else {
                @for (member of group()?.groupMembers; track member.id) {
                <tr>
                  <td>{{ member.pcoId || '-' }}</td>
                  <td>
                    <span class="member-name-wrap">
                      <span
                        class="member-avatar-chip"
                        [ngbTooltip]="memberAvatarPreview"
                        tooltipClass="member-avatar-tooltip"
                        container="body"
                      >
                        @if (memberAvatarUrl(member)) {
                        <img
                          [src]="memberAvatarUrl(member)"
                          [alt]="member.firstName + ' ' + member.lastName"
                          (error)="onMemberAvatarError(member.id)"
                        />
                        } @else {
                        <span>{{ memberInitials(member) }}</span>
                        }
                      </span>
                      <span>{{ member.firstName }} {{ member.lastName }}</span>
                    </span>
                    <ng-template #memberAvatarPreview>
                      <div class="member-avatar-preview">
                        <div class="member-avatar-preview-image">
                          @if (memberAvatarUrl(member)) {
                          <img
                            [src]="memberAvatarUrl(member)"
                            [alt]="member.firstName + ' ' + member.lastName"
                            (error)="onMemberAvatarError(member.id)"
                          />
                          } @else {
                          <span>{{ memberInitials(member) }}</span>
                          }
                        </div>
                        <div class="member-avatar-preview-name">
                          {{ member.firstName }} {{ member.lastName }}
                        </div>
                      </div>
                    </ng-template>
                    @if (member.id === group()?.leaderId) {
                    <span class="leader-pill ms-2">Leader</span>
                    }
                  </td>
                  <td>
                    <span
                      class="member-presence"
                      [class.member-presence-online]="isMemberOnline(member.id)"
                      [class.member-presence-offline]="!isMemberOnline(member.id)"
                    >
                      <span class="member-presence-dot"></span>
                      {{ isMemberOnline(member.id) ? 'Online' : 'Offline' }}
                    </span>
                  </td>
                  @if (canRemoveMembers()) {
                  <td class="text-center">
                    @if (canRemoveSpecificMember(member.id)) {
                    <button
                      class="btn btn-sm btn-outline-danger"
                      ngbTooltip="Remove from Group"
                      (click)="onRemoveMember(member.id)"
                    >
                      <i class="bi bi-person-x"></i>
                    </button>
                    } @else {
                    <span class="text-muted">-</span>
                    }
                  </td>
                  }
                </tr>
                } @empty {
                <tr>
                  <td [attr.colspan]="canRemoveMembers() ? 4 : 3" class="empty-row">
                    No members found.
                  </td>
                </tr>
                }
              }
            </tbody>
          </table>
        </div>
      </article>
    </section>

    <section class="chat-section">
      <article class="topics-card mb-3">
        <div class="members-head">
          <h3>Group Topics</h3>
        </div>

        @if (canCreateTopics()) {
        <form [formGroup]="topicForm" (ngSubmit)="onCreateTopic()" class="topic-form mb-3">
          <div class="row g-2">
            <div class="col-md-5">
              <input
                type="text"
                class="form-control"
                placeholder="Topic title"
                formControlName="title"
              />
              @if (topicTitle.invalid && topicTitle.touched) {
              <small class="text-danger">Title is required and must be 120 chars or fewer.</small>
              }
            </div>
            <div class="col-md-5">
              <input
                type="text"
                class="form-control"
                placeholder="Description (optional)"
                formControlName="description"
              />
              @if (topicDescription.invalid && topicDescription.touched) {
              <small class="text-danger">Description must be 2000 chars or fewer.</small>
              }
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-primary" type="submit" [disabled]="creatingTopic()">
                {{ creatingTopic() ? 'Creating...' : 'Create Topic' }}
              </button>
            </div>
          </div>
        </form>
        }

        @if (topicSuccessMessage()) {
        <div class="alert alert-success py-2">{{ topicSuccessMessage() }}</div>
        }
        @if (topicErrorMessage()) {
        <div class="alert alert-danger py-2">{{ topicErrorMessage() }}</div>
        }

        @if (topicsLoading()) {
        <p class="text-muted mb-0">Loading topics...</p>
        } @else {
        <div class="topic-list">
          @for (topic of topics(); track topic.id) {
          <div class="topic-item">
            <div class="topic-summary">
              <div class="topic-title">{{ topic.title }}</div>
              <p class="topic-description mb-1">{{ topicDescriptionExcerpt(topic) }}</p>
              <small class="text-muted">
                {{ topic.creator?.firstName }} {{ topic.creator?.lastName }} 路
                {{ topic.createdAt | date: 'medium' }}
              </small>
            </div>

            <div class="topic-actions">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary topic-toggle-btn"
                (click)="toggleTopicExpanded(topic.id)"
                [ngbTooltip]="isTopicExpanded(topic.id) ? 'Minimize topic' : 'Show more details'"
              >
                <i class="bi" [ngClass]="isTopicExpanded(topic.id) ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
              </button>
            </div>

            @if (isTopicExpanded(topic.id)) {
            <div class="topic-expanded mt-2">
              @if (topic.description) {
              <p class="topic-description mb-2">{{ topic.description }}</p>
              }

              <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
                <small class="text-muted">
                  Created by {{ topic.creator?.firstName }} {{ topic.creator?.lastName }} 路
                  {{ topic.createdAt | date: 'medium' }}
                </small>
                @if (canDeleteTopics()) {
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  (click)="onDeleteTopic(topic.id)"
                  ngbTooltip="Delete topic"
                >
                  <i class="bi bi-trash"></i>
                </button>
                }
              </div>

              @if (canCommentOnTopics()) {
              <div class="topic-comment-form mt-2">
                <textarea
                  class="form-control"
                  rows="2"
                  [ngModel]="getTopicCommentDraft(topic.id)"
                  (ngModelChange)="onTopicCommentInput(topic.id, $event)"
                  [ngModelOptions]="{ standalone: true }"
                  maxlength="1000"
                  placeholder="Write a comment..."
                ></textarea>
                <div class="d-flex justify-content-end mt-2">
                  <button
                    type="button"
                    class="btn btn-sm btn-primary"
                    [disabled]="creatingTopicComments()[topic.id]"
                    (click)="onCreateTopicComment(topic.id)"
                  >
                    {{ creatingTopicComments()[topic.id] ? 'Posting...' : 'Post Comment' }}
                  </button>
                </div>
              </div>
              }

              <div class="topic-comments mt-2">
                @for (comment of visibleComments(topic); track comment.id) {
                <div class="topic-comment-item">
                  <div class="topic-comment-head justify-content-between">
                    <div class="comment-avatar" [attr.aria-label]="(comment.creator?.firstName || '') + ' ' + (comment.creator?.lastName || '')">
                      @if (commentAvatarUrl(topic, comment.id)) {
                      <img
                        [src]="commentAvatarUrl(topic, comment.id)"
                        [alt]="(comment.creator?.firstName || '') + ' ' + (comment.creator?.lastName || '')"
                        (error)="onCommentAvatarError(comment.id)"
                      />
                      } @else {
                      <span>{{ commentInitials(comment.creator?.firstName, comment.creator?.lastName) }}</span>
                      }
                    </div>
                    <div>
                      <small class="text-muted d-block">
                        {{ comment.creator?.firstName }} {{ comment.creator?.lastName }} 路
                        {{ formatRelativeTime(comment.createdAt) }}
                      </small>
                    </div>
                  </div>
                  <div class="comment-actions mt-1">
                    @if (canCommentOnTopics()) {
                    <button
                      type="button"
                      class="btn btn-sm btn-link p-0 text-decoration-none comment-action-btn"
                      (click)="toggleReplyForm(comment.id)"
                    >
                      {{ isReplyFormExpanded(comment.id) ? 'Cancel' : 'Reply' }}
                    </button>
                    }
                    @if ((comment.replies || []).length) {
                    <button
                      type="button"
                      class="btn btn-sm btn-link p-0 text-decoration-none comment-action-btn"
                      (click)="toggleRepliesVisible(comment.id)"
                    >
                      {{
                        isRepliesVisible(comment.id)
                          ? 'Hide responses'
                          : 'Show responses (' + (comment.replies || []).length + ')'
                      }}
                    </button>
                    }
                    @if (canDeleteTopLevelComment(comment)) {
                    <button
                      type="button"
                      class="btn btn-sm btn-link p-0 text-danger text-decoration-none comment-action-btn"
                      (click)="onDeleteTopicComment(topic.id, comment.id)"
                    >
                      Delete
                    </button>
                    }
                  </div>
                  <p class="mb-1 mt-1">{{ comment.comment }}</p>

                  @if (isReplyFormExpanded(comment.id) && canCommentOnTopics()) {
                  <div class="reply-form mt-2">
                    <textarea
                      class="form-control"
                      rows="2"
                      [ngModel]="getReplyDraft(comment.id)"
                      (ngModelChange)="onReplyInput(comment.id, $event)"
                      [ngModelOptions]="{ standalone: true }"
                      maxlength="1000"
                      placeholder="Write a reply..."
                    ></textarea>
                    <div class="d-flex justify-content-end mt-2">
                      <button
                        type="button"
                        class="btn btn-sm btn-primary"
                        [disabled]="creatingCommentReplies()[comment.id]"
                        (click)="onCreateCommentReply(topic.id, comment.id)"
                      >
                        {{ creatingCommentReplies()[comment.id] ? 'Posting...' : 'Post Reply' }}
                      </button>
                    </div>
                  </div>
                  }

                  @if ((comment.replies || []).length && isRepliesVisible(comment.id)) {
                  <div class="comment-replies mt-2">
                    @for (reply of visibleCommentReplies(comment); track reply.id) {
                    <div class="topic-comment-item reply-item">
                      <div class="topic-comment-head justify-content-between">
                        <div class="comment-avatar" [attr.aria-label]="(reply.creator?.firstName || '') + ' ' + (reply.creator?.lastName || '')">
                          @if (commentAvatarUrl(topic, reply.id)) {
                          <img
                            [src]="commentAvatarUrl(topic, reply.id)"
                            [alt]="(reply.creator?.firstName || '') + ' ' + (reply.creator?.lastName || '')"
                            (error)="onCommentAvatarError(reply.id)"
                          />
                          } @else {
                          <span>{{ commentInitials(reply.creator?.firstName, reply.creator?.lastName) }}</span>
                          }
                        </div>
                        <div>
                          <small class="text-muted d-block">
                            {{ reply.creator?.firstName }} {{ reply.creator?.lastName }} 路
                            {{ formatRelativeTime(reply.createdAt) }}
                          </small>
                        </div>
                      </div>
                      @if (canDeleteOwnComment(reply)) {
                      <div class="comment-actions mt-1">
                        <button
                          type="button"
                          class="btn btn-sm btn-link p-0 text-danger text-decoration-none comment-action-btn"
                          (click)="onDeleteTopicComment(topic.id, reply.id)"
                        >
                          Delete
                        </button>
                      </div>
                      }
                      <p class="mb-1 mt-1">{{ reply.comment }}</p>
                    </div>
                    }
                    @if (canShowMoreReplies(comment)) {
                    <button
                      type="button"
                      class="btn btn-sm btn-link p-0 text-decoration-none comment-action-btn"
                      (click)="showMoreReplies(comment.id)"
                    >
                      Show more
                    </button>
                    }
                  </div>
                  }
                </div>
                } @empty {
                <small class="text-muted d-block">No comments yet.</small>
                }
                @if (canShowMoreComments(topic)) {
                <div class="mt-1">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    (click)="showMoreComments(topic.id)"
                  >
                    Show more
                  </button>
                </div>
                }
              </div>
            </div>
            }
          </div>
          } @empty {
          <p class="text-muted mb-0">No topics yet for this circle.</p>
          }
        </div>
        }
      </article>
    </section>

    <button
      type="button"
      class="chat-fab btn btn-primary"
      (click)="toggleChatPanel()"
      [attr.aria-expanded]="isChatOpen()"
      [attr.aria-label]="isChatOpen() ? 'Hide circle chat' : 'Show circle chat'"
    >
      <i class="bi" [ngClass]="isChatOpen() ? 'bi-x-lg' : 'bi-chat-dots-fill'"></i>
      @if (!isChatOpen() && unreadChatCount() > 0) {
      <span class="chat-fab-badge">{{ unreadChatCount() > 9 ? '9+' : unreadChatCount() }}</span>
      }
    </button>

    <aside class="floating-chat-panel" [class.chat-hidden]="!isChatOpen()">
      <app-circle-chat-panel
        [groupId]="group()?.id || null"
        [canAccess]="hasChatAccess()"
        [isOpen]="isChatOpen()"
        (unreadCountChange)="onChatUnreadCountChange($event)"
        (onlineUserIdsChange)="onOnlineUserIdsChange($event)"
      />
    </aside>
  }
</main>
