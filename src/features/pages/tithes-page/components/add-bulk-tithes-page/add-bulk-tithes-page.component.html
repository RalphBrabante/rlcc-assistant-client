<main class="bulk-page">
  <div class="container py-4 py-lg-5">
    <section class="bulk-shell">
      <header class="bulk-head">
        <h2 class="mb-1">Add Bulk Tithes</h2>
        <p class="mb-0 text-muted">Queue multiple entries, review them, then process all at once.</p>
      </header>

      @if (isSuccess()) {
        <ngb-alert type="success" class="bulk-alert">
          All queued tithes were submitted successfully.
        </ngb-alert>
      }

      <div class="bulk-form card border-0 shadow-sm">
        <div class="card-body p-3 p-lg-4">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-lg-4">
              <label class="form-label">Member</label>
              @if(fullName.value){
                <div id="tags" aria-live="polite" class="selected-member">
                  <span class="badge member-pill d-inline-flex align-items-center" data-value="member">
                    <span class="me-2">{{ fullName.value }}</span>
                    <button
                      type="button"
                      class="btn-close btn-close-white btn-sm"
                      aria-label="Remove selected member"
                      (click)="clearMemberIdAndName()"
                    ></button>
                  </span>
                </div>
              } @else {
                <app-active-members-lookup-dropdown
                  (emitMemberId)="setMemberId($event)"
                  (emitMemberName)="setFullName($event)"
                />
              }
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label">Type of Giving</label>
              <app-active-tithe-type-dropdown
                (emitTitheTypeId)="setTitheTypeId($event)"
                (emitTitheTypeName)="setTitheTypeName($event)"
              />
            </div>

            <div class="col-12 col-sm-6 col-lg-2">
              <form [formGroup]="form">
                <label class="form-label">Date Received</label>
                <input type="date" class="form-control" formControlName="dateReceived" />
              </form>
            </div>

            <div class="col-12 col-sm-6 col-lg-2">
              <form [formGroup]="form">
                <label class="form-label">Amount</label>
                <input
                  type="text"
                  placeholder="0.00"
                  (input)="formatToTwoDecimals($event)"
                  class="form-control"
                  formControlName="amount"
                />
              </form>
            </div>

            <div class="col-12 col-lg-1 d-grid">
              <button class="btn btn-success add-row-btn" (click)="addToList()" [disabled]="this.form.invalid">
                <i class="bi bi-plus-circle-fill me-1"></i>
                Add
              </button>
            </div>
          </div>
        </div>
      </div>

      @if (tithesArray().length) {
        <div class="queue-summary">
          <div class="summary-item">
            <span class="summary-label">Queued Entries</span>
            <span class="summary-value">{{ queuedCount() }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Queued Total</span>
            <span class="summary-value">{{ queuedTotalAmount() | currency :"PHP" }}</span>
          </div>
        </div>

        <div class="queue-list mt-3">
          <div class="queue-table-head d-none d-md-grid">
            <span>Member Name</span>
            <span>Tithe Type</span>
            <span>Date Received</span>
            <span class="text-end">Amount</span>
          </div>

          @for (tithe of tithesArray(); track $index) {
            <article class="queue-item card border-0 shadow-sm">
              <div class="card-body">
                <div class="queue-grid">
                  <div>
                    <span class="queue-label d-md-none">Member</span>
                    <div class="queue-value fw-semibold">{{ tithe.fullName }}</div>
                  </div>
                  <div>
                    <span class="queue-label d-md-none">Type</span>
                    <div class="queue-value text-muted">{{ tithe.titheTypeName }}</div>
                  </div>
                  <div>
                    <span class="queue-label d-md-none">Date</span>
                    <div class="queue-value text-secondary">{{ tithe.dateReceived }}</div>
                  </div>
                  <div class="queue-amount">
                    <span class="queue-label d-md-none">Amount</span>
                    <div class="queue-value fw-bold text-success">{{ tithe.amount | currency :"PHP" }}</div>
                    <button class="btn btn-sm btn-outline-danger ms-2" (click)="removeTithe(tithe.index)">
                      <i class="bi bi-trash-fill"></i>
                    </button>
                  </div>
                </div>
              </div>
            </article>
          }
        </div>

        <div class="process-actions mt-4">
          <button class="btn btn-primary process-btn" *ngIf="!isProcessing()" (click)="processTithes()">
            Process All Tithes
            <i class="bi bi-send-plus ms-1"></i>
          </button>

          <button class="btn btn-primary process-btn" *ngIf="isProcessing()" disabled>
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Processing...
          </button>
        </div>
      }
    </section>
  </div>
</main>
